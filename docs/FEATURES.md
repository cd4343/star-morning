# 星辰动力 / Star Coin - 功能清单与业务规则

## 孩子端

### 任务
- 查看当日/本周任务，计时提交，可填证明与用时
- 任务状态：待完成 → 待审核 → 已通过/已拒绝
- 已审核任务可点开查看审批详情（含惩罚扣分说明）

### 心愿与抽奖
- **商店**：金币兑换商品，入背包「待兑现」
- **储蓄**：向储蓄目标存入金币，达成后入背包
- **抽奖**：转盘 8 格，消耗金币抽奖，中奖入背包；费用随当日已抽次数递增
- **再抽一次**：中奖「再抽一次」类奖品后，该道具进入背包；在背包中点击「使用」→ 消耗该道具并获得一次免费抽奖，新奖品入背包
- **特权**：特权点兑换特权，入背包

### 背包
- 列表来源：商店/抽奖/特权/储蓄；抽奖来源项会带 `effectType`（再抽一次类显示「使用」）
- 待兑现：可「兑现」或（部分）「撤销」；再抽一次类仅「使用」，不可撤销
- 筛选：全部 / 待兑现 / 已兑现 / 已撤销

### 个人页（Me）
- 成就进度、连续打卡等
- 惩罚记录：总次数、总扣款、按时间筛选、按等级统计；支持详情弹窗；等级含「自定义扣除」

---

## 家长端

### 仪表盘
- 待审核任务列表、审核历史（按日期）
- 审核弹窗：综合评分（时间/质量/主动性）、可选惩罚（轻度/中度/严重/自定义）
- 自定义惩罚：选择「自定义」后输入扣除金币数（受惩罚设置中的 min/max 限制）
- 任务详情弹窗：展示奖励与惩罚信息（含自定义等级显示）

### 惩罚设置
- 启用/关闭惩罚
- 轻度/中度/严重：名称、比例、加减额、上下限
- **自定义扣除**：名称、最小扣除、最大扣除（审核时在此范围内输入具体金额）
- 负余额允许及下限、是否通知孩子、是否必填原因

### 心愿管理
- 商店商品、储蓄目标、抽奖奖池（最多 8 个上架）
- 抽奖奖品：名称、图标、权重、稀有度、**效果类型**（普通 / 再抽一次）
- 模板添加时，「再抽一次」「再来一次机会」自动设为效果类型「再抽一次」

### 任务管理、成就、特权、家庭
- 任务 CRUD、模板；成就规则；特权列表；家庭成员与 PIN

---

## 通用规则

- **时间**：所有业务日期/“当天”以**北京时间 (UTC+8)** 为准；见 `server.ts` 中 `getBeijingDate`、`getLocalDateString`、`getBeijingTimeString`。
- **自动审批**：仅对提交日期早于“今天”（北京时间）的 pending 任务执行，且按中间档奖励。
- **惩罚等级**：mild / moderate / severe / custom；custom 时扣款由家长输入，且必须在设置的 customMin～customMax 之间。
- **再抽一次**：奖品 `wishes.effectType = 'draw_again'`；抽到后不放入背包，直接弹窗提示并调用 `POST /api/child/lottery/redraw` 立即免费再抽。
